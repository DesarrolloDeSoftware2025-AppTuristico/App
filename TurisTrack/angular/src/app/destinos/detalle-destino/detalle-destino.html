<div class="container mt-5" *ngIf="loading">
  <div class="d-flex justify-content-center">
    <div class="spinner-border text-primary" role="status"></div>
  </div>
</div>

<div class="container mt-4 mb-5" *ngIf="!loading && destino">
  
  <div class="card shadow-lg border-0 overflow-hidden mb-5">
    
    <div class="bg-primary text-white p-5 text-center">
        <h1 class="display-4 fw-bold">{{ destino.nombre }}</h1>
        <p class="fs-3"><i class="fa fa-flag me-2"></i> {{ destino.pais }}</p>
    </div>

    <div class="card-body p-4">
        <div class="row">
            <div class="col-md-7">
               <h4 class="mb-4 text-secondary border-bottom pb-2">Información del Destino</h4>
                
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Región:</div>
                    <div class="col-sm-8">{{ destino.region || 'No especificada' }} ({{ destino.codigoRegion }})</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Población:</div>
                    <div class="col-sm-8">{{ destino.poblacion | number }} habitantes</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Zona Horaria:</div>
                    <div class="col-sm-8">{{ destino.zonaHoraria }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Coordenadas:</div>
                    <div class="col-sm-8">Lat: {{ destino.latitud }}, Long: {{ destino.longitud }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 fw-bold">Elevación:</div>
                    <div class="col-sm-8">{{ destino.metrosDeElevacion }} metros</div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center text-center p-4">
                        <i class="fa fa-map-marked-alt text-success mb-3" style="font-size: 5rem;"></i>
                        <h5 class="mb-3">¿Te interesa este lugar?</h5>
                        <p class="text-muted mb-4">Guárdalo para gestionar tus viajes y dejar reseñas.</p>
                        
                        <button class="btn btn-lg w-100 shadow fw-bold" 
                                [ngClass]="destino.estaGuardado ? 'btn-secondary' : 'btn-success'"
                                (click)="!destino.estaGuardado && guardarEnBaseDeDatos()" 
                                [disabled]="guardando || destino.estaGuardado">
                            
                            <span *ngIf="guardando" class="spinner-border spinner-border-sm me-2"></span>
                            
                            <span *ngIf="!guardando && !destino.estaGuardado">
                                <i class="fa fa-save me-2"></i> Guardar Destino
                            </span>
                            
                            <span *ngIf="!guardando && destino.estaGuardado">
                                <i class="fa fa-check-circle me-2"></i> Destino Guardado
                            </span>
                        </button>

                        <small class="text-muted mt-2 text-center d-block" *ngIf="destino.estaGuardado">
                            Disponible en tu lista personal.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-footer bg-white border-0 py-3">
        <button class="btn btn-outline-secondary" onclick="history.back()">
            <i class="fa fa-arrow-left me-2"></i> Volver al listado
        </button>
    </div>
  </div>

  <div *ngIf="destino.estaGuardado" class="row">
    
    <div class="col-lg-8">
        <h3 class="mb-4"><i class="fa fa-comments text-primary me-2"></i>Opiniones de Viajeros</h3>
        
        <div *ngIf="comentarios.length === 0" class="alert alert-light border text-center py-4">
            <i class="fa fa-comment-slash fa-2x text-muted mb-2"></i>
            <p class="mb-0">Aún no hay comentarios. ¡Sé el primero en opinar!</p>
        </div>

        <div class="comment-list">
            <div class="card mb-3 shadow-sm border-0" 
                 *ngFor="let com of comentarios"
                 [ngClass]="{'border-start border-4 border-primary bg-light': com.userId === currentUserId}">
                 
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="fw-bold mb-0" [ngClass]="com.userId === currentUserId ? 'text-primary' : 'text-dark'">
                                {{ com.userName }} 
                                <span *ngIf="com.userId === currentUserId" class="badge bg-primary ms-2" style="font-size: 0.7rem;">Tú</span>
                            </h6>
                            <small class="text-muted">{{ com.creationTime | date:'mediumDate' }}</small>
                        </div>

                        <div *ngIf="com.userId === currentUserId" class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" (click)="abrirModalEdicion(com)" title="Editar">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button class="btn btn-outline-danger" (click)="eliminarComentario(com.id)" title="Eliminar">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2 text-warning">
                        <i class="fa fa-star" *ngFor="let s of [1,2,3,4,5]" 
                           [ngClass]="{'text-warning': s <= com.puntuacion, 'text-muted opacity-25': s > com.puntuacion}"></i>
                    </div>
                    
                    <p class="card-text text-secondary" style="white-space: pre-wrap;">{{ com.comentario || 'Sin comentario escrito.' }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        
        <div class="card border-0 shadow-sm mb-4 bg-primary text-white">
            <div class="card-body text-center">
                <h1 class="display-3 fw-bold mb-0">{{ resumen.promedio }}</h1>
                <div class="text-warning mb-2 fs-4">
                     <i class="fa fa-star" *ngFor="let s of [1,2,3,4,5]" 
                        [ngClass]="{'text-white': s <= mathRound(resumen.promedio), 'text-white-50': s > mathRound(resumen.promedio)}"></i>
                </div>
                <p class="mb-0 small opacity-75">{{ resumen.totalCalificaciones }} valoraciones totales</p>
            </div>
        </div>

        <div *ngIf="usuarioYaComento" class="alert alert-success border-0 shadow-sm text-center">
            <i class="fa fa-check-circle fa-2x mb-2 text-success"></i>
            <h5 class="alert-heading h6 fw-bold">¡Ya has opinado!</h5>
            <p class="mb-0 small">Gracias por compartir tu experiencia.</p>
            <hr class="my-2">
            <small class="text-muted" style="font-size: 0.75rem;">Puedes editar o eliminar tu reseña en la lista.</small>
        </div>

        <div class="card border-0 shadow-sm" *ngIf="isLoggedIn && !usuarioYaComento">
            <div class="card-header bg-white fw-bold">
                <i class="fa fa-pen me-1 text-primary"></i> Escribe tu reseña
            </div>
            <div class="card-body">
                
                <div class="mb-3 text-center">
                    <label class="form-label d-block text-muted small">Toca las estrellas</label>
                    <div class="star-rating fs-2">
                        <i class="fa fa-star cursor-pointer" *ngFor="let s of [1,2,3,4,5]" 
                           (click)="seleccionarEstrella(s)"
                           [ngClass]="{'text-warning': s <= nuevaPuntuacion, 'text-muted': s > nuevaPuntuacion}"
                           style="cursor: pointer; transition: transform 0.2s;"
                           onmouseover="this.style.transform='scale(1.2)'"
                           onmouseout="this.style.transform='scale(1)'">
                        </i>
                    </div>
                </div>

                <div class="mb-3">
                    <textarea class="form-control bg-light" rows="3" 
                              placeholder="¿Qué te pareció este lugar?" 
                              [(ngModel)]="nuevoComentario"></textarea>
                </div>

                <button class="btn btn-primary w-100" 
                        (click)="enviarCalificacion()" 
                        [disabled]="enviandoCalificacion || nuevaPuntuacion === 0">
                    <span *ngIf="enviandoCalificacion" class="spinner-border spinner-border-sm me-2"></span>
                    Publicar Opinión
                </button>
            </div>
        </div>

        <div *ngIf="!isLoggedIn" class="alert alert-warning mt-3 shadow-sm">
            <i class="fa fa-lock me-2"></i> <a href="/account/login" class="alert-link">Inicia sesión</a> para comentar.
        </div>

    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="comentarioEnEdicion"></div>

<div class="modal fade show d-block" tabindex="-1" *ngIf="comentarioEnEdicion">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i>Editar tu opinión</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModalEdicion()"></button>
      </div>
      
      <div class="modal-body text-center p-4">
        
        <label class="form-label text-muted fw-bold">Calificación</label>
        <div class="fs-1 mb-4">
             <i class="fa fa-star cursor-pointer" *ngFor="let s of [1,2,3,4,5]" 
                (click)="seleccionarEstrellaEdit(s)"
                [ngClass]="{'text-warning': s <= editPuntuacion, 'text-muted': s > editPuntuacion}"
                style="cursor: pointer;">
             </i>
        </div>

        <div class="text-start">
            <label class="form-label text-muted fw-bold">Tu comentario</label>
            <textarea class="form-control bg-light" rows="4" [(ngModel)]="editComentario"></textarea>
        </div>

      </div>
      
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary" (click)="cerrarModalEdicion()">Cancelar</button>
        <button type="button" class="btn btn-primary px-4" (click)="guardarEdicion()" [disabled]="editando">
            <span *ngIf="editando" class="spinner-border spinner-border-sm me-2"></span>
            Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>